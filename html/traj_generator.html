
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>traj_generator</title><meta name="generator" content="MATLAB 8.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-09-03"><meta name="DC.source" content="traj_generator.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">Example code:</a></li><li><a href="#4">Fill in your code here</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [ desired_state ] = traj_generator(t_real, state, waypoints)
</pre><pre class="codeinput"><span class="comment">% TRAJ_GENERATOR: Generate the trajectory passing through all</span>
<span class="comment">% positions listed in the waypoints list</span>
<span class="comment">%</span>
<span class="comment">% NOTE: This function would be called with variable number of input arguments.</span>
<span class="comment">% During initialization, it will be called with arguments</span>
<span class="comment">% trajectory_generator([], [], waypoints) and later, while testing, it will be</span>
<span class="comment">% called with only t and state as arguments, so your code should be able to</span>
<span class="comment">% handle that. This can be done by checking the number of arguments to the</span>
<span class="comment">% function using the "nargin" variable, check the MATLAB documentation for more</span>
<span class="comment">% information.</span>
<span class="comment">%</span>
<span class="comment">% t,state: time and current state (same variable as "state" in controller)</span>
<span class="comment">% that you may use for computing desired_state</span>
<span class="comment">%</span>
<span class="comment">% waypoints: The 3xP matrix listing all the points you much visited in order</span>
<span class="comment">% along the generated trajectory</span>
<span class="comment">%</span>
<span class="comment">% desired_state: Contains all the information that is passed to the</span>
<span class="comment">% controller for generating inputs for the quadrotor</span>
<span class="comment">%</span>
<span class="comment">% It is suggested to use "persistent" variables to store the waypoints during</span>
<span class="comment">% the initialization call of trajectory_generator.</span>
</pre><h2>Example code:<a name="3"></a></h2><p>Note that this is an example of naive trajectory generator that simply moves the quadrotor along a stright line between each pair of consecutive waypoints using a constant velocity of 0.5 m/s. Note that this is only a sample, and you should write your own trajectory generator for the submission.</p><pre class="codeinput"><span class="comment">% persistent waypoints0 traj_time d0</span>
<span class="comment">% if nargin &gt; 2</span>
<span class="comment">%     d = waypoints(:,2:end) - waypoints(:,1:end-1);</span>
<span class="comment">%     d0 = 2 * sqrt(d(1,:).^2 + d(2,:).^2 + d(3,:).^2);</span>
<span class="comment">%     traj_time = [0, cumsum(d0)];</span>
<span class="comment">%     waypoints0 = waypoints;</span>
<span class="comment">% else</span>
<span class="comment">%     if(t &gt; traj_time(end))</span>
<span class="comment">%         t = traj_time(end);</span>
<span class="comment">%     end</span>
<span class="comment">%     t_index = find(traj_time &gt;= t,1);</span>
<span class="comment">%</span>
<span class="comment">%     if(t_index &gt; 1)</span>
<span class="comment">%         t = t - traj_time(t_index-1);</span>
<span class="comment">%     end</span>
<span class="comment">%     if(t == 0)</span>
<span class="comment">%         desired_state.pos = waypoints0(:,1);</span>
<span class="comment">%     else</span>
<span class="comment">%         scale = t/d0(t_index-1);</span>
<span class="comment">%         desired_state.pos = (1 - scale) * waypoints0(:,t_index-1) + scale * waypoints0(:,t_index);</span>
<span class="comment">%     end</span>
<span class="comment">%     desired_state.vel = zeros(3,1);</span>
<span class="comment">%     desired_state.acc = zeros(3,1);</span>
<span class="comment">%     desired_state.yaw = 0;</span>
<span class="comment">%     desired_state.yawdot = 0;</span>
<span class="comment">% end</span>
<span class="comment">%</span>
</pre><h2>Fill in your code here<a name="4"></a></h2><pre class="codeinput"><span class="keyword">persistent</span> X1 X2 X3
<span class="keyword">persistent</span> waypoints0 traj_time d0
<span class="keyword">if</span> nargin &gt; 2
    d = waypoints(:,2:end) - waypoints(:,1:end-1);
    d0 = 2 * sqrt(d(1,:).^2 + d(2,:).^2 + d(3,:).^2);
    traj_time = [0, cumsum(d0)];
    waypoints0 = waypoints;
    <span class="comment">%    we should solve for x, y, z independently, we really need coefficients alpha_ij^x, alpha_ij^y, alpha_ij^z and they will be different.</span>
    <span class="comment">%    https://www.coursera.org/learn/robotics-flight/discussions/weeks/4/threads/7Ug8_GpJEeasOQpiYXGJHw</span>

    syms <span class="string">t</span> <span class="string">positive</span>
    syms <span class="string">c_1_0</span> <span class="string">c_1_1</span> <span class="string">c_1_2</span> <span class="string">c_1_3</span> <span class="string">c_1_4</span> <span class="string">c_1_5</span> <span class="string">c_1_6</span> <span class="string">c_1_7</span> <span class="string">real</span>
    syms <span class="string">c_2_0</span> <span class="string">c_2_1</span> <span class="string">c_2_2</span> <span class="string">c_2_3</span> <span class="string">c_2_4</span> <span class="string">c_2_5</span> <span class="string">c_2_6</span> <span class="string">c_2_7</span> <span class="string">real</span>
    syms <span class="string">c_3_0</span> <span class="string">c_3_1</span> <span class="string">c_3_2</span> <span class="string">c_3_3</span> <span class="string">c_3_4</span> <span class="string">c_3_5</span> <span class="string">c_3_6</span> <span class="string">c_3_7</span> <span class="string">real</span>
    syms <span class="string">c_4_0</span> <span class="string">c_4_1</span> <span class="string">c_4_2</span> <span class="string">c_4_3</span> <span class="string">c_4_4</span> <span class="string">c_4_5</span> <span class="string">c_4_6</span> <span class="string">c_4_7</span> <span class="string">real</span>
    syms <span class="string">p1</span> <span class="string">p2</span> <span class="string">p3</span> <span class="string">p4</span>
    S0 = traj_time(1);
    S1 = traj_time(2);
    S2 = traj_time(3);
    S3 = traj_time(4);
    S4 = traj_time(5);
    p1 = c_1_0 + c_1_1*(t-S0)/(S1-S0) + c_1_2*((t-S0)/(S1-S0))^2 + c_1_3*((t-S0)/(S1-S0))^3 + c_1_4*((t-S0)/(S1-S0))^4 + c_1_5*((t-S0)/(S1-S0))^5 + c_1_6*((t-S0)/(S1-S0))^6 + c_1_7*((t-S0)/(S1-S0))^7;
    p2 = c_2_0 + c_2_1*(t-S1)/(S2-S1) + c_2_2*((t-S1)/(S2-S1))^2 + c_2_3*((t-S1)/(S2-S1))^3 + c_2_4*((t-S1)/(S2-S1))^4 + c_2_5*((t-S1)/(S2-S1))^5 + c_2_6*((t-S1)/(S2-S1))^6 + c_2_7*((t-S1)/(S2-S1))^7;
    p3 = c_3_0 + c_3_1*(t-S2)/(S3-S2) + c_3_2*((t-S2)/(S3-S2))^2 + c_3_3*((t-S2)/(S3-S2))^3 + c_3_4*((t-S2)/(S3-S2))^4 + c_3_5*((t-S2)/(S3-S2))^5 + c_3_6*((t-S2)/(S3-S2))^6 + c_3_7*((t-S2)/(S3-S2))^7;
    p4 = c_4_0 + c_4_1*(t-S3)/(S4-S3) + c_4_2*((t-S3)/(S4-S3))^2 + c_4_3*((t-S3)/(S4-S3))^3 + c_4_4*((t-S3)/(S4-S3))^4 + c_4_5*((t-S3)/(S4-S3))^5 + c_4_6*((t-S3)/(S4-S3))^6 + c_4_7*((t-S3)/(S4-S3))^7;

    p1dot = diff(p1,t);
    p2dot = diff(p2,t);
    p3dot = diff(p3,t);
    p4dot = diff(p4,t);
    p1dot2 = diff(p1dot, t);
    p2dot2 = diff(p2dot, t);
    p3dot2 = diff(p3dot, t);
    p4dot2 = diff(p4dot, t);
    p1dot3 = diff(p1dot2, t);
    p2dot3 = diff(p2dot2, t);
    p3dot3 = diff(p3dot2, t);
    p4dot3 = diff(p4dot2, t);
    p1dot4 = diff(p1dot3, t);
    p2dot4 = diff(p2dot3, t);
    p3dot4 = diff(p3dot3, t);
    p4dot4 = diff(p4dot3, t);
    p1dot5 = diff(p1dot4, t);
    p2dot5 = diff(p2dot4, t);
    p3dot5 = diff(p3dot4, t);
    p4dot5 = diff(p4dot4, t);
    p1dot6 = diff(p1dot5, t);
    p2dot6 = diff(p2dot5, t);
    p3dot6 = diff(p3dot5, t);
    p4dot6 = diff(p4dot5, t);

    A = zeros(32, 32);
    b = zeros(32, 1);


    A(1, 1:8) = subs(jacobian(p1, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(2, 1:8) = subs(jacobian(p1, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(3, 9:16) = subs(jacobian(p2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(4, 9:16) = subs(jacobian(p2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(5, 17:24) = subs(jacobian(p3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(6, 17:24) = subs(jacobian(p3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(7, 25:32) = subs(jacobian(p4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(8, 25:32) = subs(jacobian(p4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(9, 1:8) = subs(jacobian(p1dot, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(10, 25:32) = subs(jacobian(p4dot, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(11, 1:8) = subs(jacobian(p1dot2, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(12, 25:32) = subs(jacobian(p4dot2, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(13, 1:8) = subs(jacobian(p1dot3, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(14, 25:32) = subs(jacobian(p4dot3, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);

    A(15, 1:8) = subs(jacobian(p1dot, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(15, 9:16) = -subs(jacobian(p2dot, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(16, 1:8) = subs(jacobian(p1dot2, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(16, 9:16) = -subs(jacobian(p2dot2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(17, 1:8) = subs(jacobian(p1dot3, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(17, 9:16) = -subs(jacobian(p2dot3, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(18, 1:8) = subs(jacobian(p1dot4, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(18, 9:16) = -subs(jacobian(p2dot4, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(19, 1:8) = subs(jacobian(p1dot5, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(19, 9:16) = -subs(jacobian(p2dot5, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(20, 1:8) = subs(jacobian(p1dot6, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(20, 9:16) = -subs(jacobian(p2dot6, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);

    A(21, 9:16) = subs(jacobian(p2dot, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(21, 17:24) = -subs(jacobian(p3dot, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(22, 9:16) = subs(jacobian(p2dot2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(22, 17:24) = -subs(jacobian(p3dot2, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(23, 9:16) = subs(jacobian(p2dot3, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(23, 17:24) = -subs(jacobian(p3dot3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(24, 9:16) = subs(jacobian(p2dot4, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(24, 17:24) = -subs(jacobian(p3dot4, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(25, 9:16) = subs(jacobian(p2dot5, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(25, 17:24) = -subs(jacobian(p3dot5, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(26, 9:16) = subs(jacobian(p2dot6, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(26, 17:24) = -subs(jacobian(p3dot6, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);

    A(27, 17:24) = subs(jacobian(p3dot, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(27, 25:32) = -subs(jacobian(p4dot, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(28, 17:24) = subs(jacobian(p3dot2, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(28, 25:32) = -subs(jacobian(p4dot2, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(29, 17:24) = subs(jacobian(p3dot3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(29, 25:32) = -subs(jacobian(p4dot3, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(30, 17:24) = subs(jacobian(p3dot4, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(30, 25:32) = -subs(jacobian(p4dot4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(31, 17:24) = subs(jacobian(p3dot5, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(31, 25:32) = -subs(jacobian(p4dot5, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(32, 17:24) = subs(jacobian(p3dot6, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(32, 25:32) = -subs(jacobian(p4dot6, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    <span class="keyword">for</span> k = 1:3
        <span class="keyword">for</span> i = 1:(size(waypoints, 2)-1)
            b(2*i-1) = waypoints(k, i);
            b(2*i) = waypoints(k, i+1);
        <span class="keyword">end</span>
        <span class="keyword">if</span>(k == 1)
            X1 = A \ b;
        <span class="keyword">elseif</span>(k==2)
            X2 = A \ b;
        <span class="keyword">elseif</span>(k==3)
            X3 = A \ b;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">else</span>
<span class="comment">%     the next line, syms function, really takes a very long time, so DO NOT USE IT DURING LOOP!</span>
<span class="comment">%     syms t</span>
    S0 = traj_time(1);
    S1 = traj_time(2);
    S2 = traj_time(3);
    S3 = traj_time(4);
    S4 = traj_time(5);
<span class="comment">%</span>
<span class="comment">%     p1x = X1(1) + X1(2)*(t-S0)/(S1-S0) + X1(3)*((t-S0)/(S1-S0))^2 + X1(4)*((t-S0)/(S1-S0))^3 + X1(5)*((t-S0)/(S1-S0))^4 + X1(6)*((t-S0)/(S1-S0))^5 + X1(7)*((t-S0)/(S1-S0))^6 + X1(8)*((t-S0)/(S1-S0))^7;</span>
<span class="comment">%     p2x = X1(9) + X1(10)*(t-S1)/(S2-S1) + X1(11)*((t-S1)/(S2-S1))^2 + X1(12)*((t-S1)/(S2-S1))^3 + X1(13)*((t-S1)/(S2-S1))^4 + X1(14)*((t-S1)/(S2-S1))^5 + X1(15)*((t-S1)/(S2-S1))^6 + X1(16)*((t-S1)/(S2-S1))^7;</span>
<span class="comment">%     p3x = X1(17) + X1(18)*(t-S2)/(S3-S2) + X1(19)*((t-S2)/(S3-S2))^2 + X1(20)*((t-S2)/(S3-S2))^3 + X1(21)*((t-S2)/(S3-S2))^4 + X1(22)*((t-S2)/(S3-S2))^5 + X1(23)*((t-S2)/(S3-S2))^6 + X1(24)*((t-S2)/(S3-S2))^7;</span>
<span class="comment">%     p4x = X1(25) + X1(26)*(t-S3)/(S4-S3) + X1(27)*((t-S3)/(S4-S3))^2 + X1(28)*((t-S3)/(S4-S3))^3 + X1(29)*((t-S3)/(S4-S3))^4 + X1(30)*((t-S3)/(S4-S3))^5 + X1(31)*((t-S3)/(S4-S3))^6 + X1(32)*((t-S3)/(S4-S3))^7;</span>
<span class="comment">%</span>
<span class="comment">%     p1y = X2(1) + X2(2)*(t-S0)/(S1-S0) + X2(3)*((t-S0)/(S1-S0))^2 + X2(4)*((t-S0)/(S1-S0))^3 + X2(5)*((t-S0)/(S1-S0))^4 + X2(6)*((t-S0)/(S1-S0))^5 + X2(7)*((t-S0)/(S1-S0))^6 + X2(8)*((t-S0)/(S1-S0))^7;</span>
<span class="comment">%     p2y = X2(9) + X2(10)*(t-S1)/(S2-S1) + X2(11)*((t-S1)/(S2-S1))^2 + X2(12)*((t-S1)/(S2-S1))^3 + X2(13)*((t-S1)/(S2-S1))^4 + X2(14)*((t-S1)/(S2-S1))^5 + X2(15)*((t-S1)/(S2-S1))^6 + X2(16)*((t-S1)/(S2-S1))^7;</span>
<span class="comment">%     p3y = X2(17) + X2(18)*(t-S2)/(S3-S2) + X2(19)*((t-S2)/(S3-S2))^2 + X2(20)*((t-S2)/(S3-S2))^3 + X2(21)*((t-S2)/(S3-S2))^4 + X2(22)*((t-S2)/(S3-S2))^5 + X2(23)*((t-S2)/(S3-S2))^6 + X2(24)*((t-S2)/(S3-S2))^7;</span>
<span class="comment">%     p4y = X2(25) + X2(26)*(t-S3)/(S4-S3) + X2(27)*((t-S3)/(S4-S3))^2 + X2(28)*((t-S3)/(S4-S3))^3 + X2(29)*((t-S3)/(S4-S3))^4 + X2(30)*((t-S3)/(S4-S3))^5 + X2(31)*((t-S3)/(S4-S3))^6 + X2(32)*((t-S3)/(S4-S3))^7;</span>
<span class="comment">%</span>
<span class="comment">%     p1z = X3(1) + X3(2)*(t-S0)/(S1-S0) + X3(3)*((t-S0)/(S1-S0))^2 + X3(4)*((t-S0)/(S1-S0))^3 + X3(5)*((t-S0)/(S1-S0))^4 + X3(6)*((t-S0)/(S1-S0))^5 + X3(7)*((t-S0)/(S1-S0))^6 + X3(8)*((t-S0)/(S1-S0))^7;</span>
<span class="comment">%     p2z = X3(9) + X3(10)*(t-S1)/(S2-S1) + X3(11)*((t-S1)/(S2-S1))^2 + X3(12)*((t-S1)/(S2-S1))^3 + X3(13)*((t-S1)/(S2-S1))^4 + X3(14)*((t-S1)/(S2-S1))^5 + X3(15)*((t-S1)/(S2-S1))^6 + X3(16)*((t-S1)/(S2-S1))^7;</span>
<span class="comment">%     p3z = X3(17) + X3(18)*(t-S2)/(S3-S2) + X3(19)*((t-S2)/(S3-S2))^2 + X3(20)*((t-S2)/(S3-S2))^3 + X3(21)*((t-S2)/(S3-S2))^4 + X3(22)*((t-S2)/(S3-S2))^5 + X3(23)*((t-S2)/(S3-S2))^6 + X3(24)*((t-S2)/(S3-S2))^7;</span>
<span class="comment">%     p4z = X3(25) + X3(26)*(t-S3)/(S4-S3) + X3(27)*((t-S3)/(S4-S3))^2 + X3(28)*((t-S3)/(S4-S3))^3 + X3(29)*((t-S3)/(S4-S3))^4 + X3(30)*((t-S3)/(S4-S3))^5 + X3(31)*((t-S3)/(S4-S3))^6 + X3(32)*((t-S3)/(S4-S3))^7;</span>

    <span class="keyword">if</span>(t_real &gt;= traj_time(end))
        t_real = traj_time(end);
    <span class="keyword">end</span>

    <span class="keyword">if</span>(t_real&gt;=traj_time(1) &amp;&amp; t_real&lt;traj_time(2))
        desired_state.pos(1,1) = X1(1) + X1(2)*(t_real-S0)/(S1-S0) + X1(3)*((t_real-S0)/(S1-S0))^2 + X1(4)*((t_real-S0)/(S1-S0))^3 + X1(5)*((t_real-S0)/(S1-S0))^4 + X1(6)*((t_real-S0)/(S1-S0))^5 + X1(7)*((t_real-S0)/(S1-S0))^6 + X1(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.pos(2,1) = X2(1) + X2(2)*(t_real-S0)/(S1-S0) + X2(3)*((t_real-S0)/(S1-S0))^2 + X2(4)*((t_real-S0)/(S1-S0))^3 + X2(5)*((t_real-S0)/(S1-S0))^4 + X2(6)*((t_real-S0)/(S1-S0))^5 + X2(7)*((t_real-S0)/(S1-S0))^6 + X2(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.pos(3,1) = X3(1) + X3(2)*(t_real-S0)/(S1-S0) + X3(3)*((t_real-S0)/(S1-S0))^2 + X3(4)*((t_real-S0)/(S1-S0))^3 + X3(5)*((t_real-S0)/(S1-S0))^4 + X3(6)*((t_real-S0)/(S1-S0))^5 + X3(7)*((t_real-S0)/(S1-S0))^6 + X3(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.vel(1,1) = X1(2)/(S1-S0) + X1(3)*2*(t_real-S0)/((S1-S0)^2) + X1(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X1(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X1(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X1(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X1(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.vel(2,1) = X2(2)/(S1-S0) + X2(3)*2*(t_real-S0)/((S1-S0)^2) + X2(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X2(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X2(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X2(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X2(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.vel(3,1) = X3(2)/(S1-S0) + X3(3)*2*(t_real-S0)/((S1-S0)^2) + X3(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X3(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X3(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X3(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X3(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.acc(1,1) = X1(3)*2/((S1-S0)^2) + X1(4)*3*2*(t_real-S0)/((S1-S0)^3) + X1(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X1(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X1(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X1(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
        desired_state.acc(2,1) = X2(3)*2/((S1-S0)^2) + X2(4)*3*2*(t_real-S0)/((S1-S0)^3) + X2(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X2(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X2(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X2(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
        desired_state.acc(3,1) = X3(3)*2/((S1-S0)^2) + X3(4)*3*2*(t_real-S0)/((S1-S0)^3) + X3(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X3(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X3(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X3(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
    <span class="keyword">elseif</span>(t_real&gt;=traj_time(2) &amp;&amp; t_real&lt;traj_time(3))
		desired_state.pos(1,1) = X1(1+8) + X1(2+8)*(t_real-S1)/(S2-S1) + X1(3+8)*((t_real-S1)/(S2-S1))^2 + X1(4+8)*((t_real-S1)/(S2-S1))^3 + X1(5+8)*((t_real-S1)/(S2-S1))^4 + X1(6+8)*((t_real-S1)/(S2-S1))^5 + X1(7+8)*((t_real-S1)/(S2-S1))^6 + X1(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.pos(2,1) = X2(1+8) + X2(2+8)*(t_real-S1)/(S2-S1) + X2(3+8)*((t_real-S1)/(S2-S1))^2 + X2(4+8)*((t_real-S1)/(S2-S1))^3 + X2(5+8)*((t_real-S1)/(S2-S1))^4 + X2(6+8)*((t_real-S1)/(S2-S1))^5 + X2(7+8)*((t_real-S1)/(S2-S1))^6 + X2(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.pos(3,1) = X3(1+8) + X3(2+8)*(t_real-S1)/(S2-S1) + X3(3+8)*((t_real-S1)/(S2-S1))^2 + X3(4+8)*((t_real-S1)/(S2-S1))^3 + X3(5+8)*((t_real-S1)/(S2-S1))^4 + X3(6+8)*((t_real-S1)/(S2-S1))^5 + X3(7+8)*((t_real-S1)/(S2-S1))^6 + X3(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.vel(1,1) = X1(2+8)/(S2-S1) + X1(3+8)*2*(t_real-S1)/((S2-S1)^2) + X1(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X1(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X1(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X1(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X1(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.vel(2,1) = X2(2+8)/(S2-S1) + X2(3+8)*2*(t_real-S1)/((S2-S1)^2) + X2(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X2(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X2(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X2(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X2(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.vel(3,1) = X3(2+8)/(S2-S1) + X3(3+8)*2*(t_real-S1)/((S2-S1)^2) + X3(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X3(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X3(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X3(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X3(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.acc(1,1) = X1(3+8)*2/((S2-S1)^2) + X1(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X1(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X1(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X1(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X1(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);
        desired_state.acc(2,1) = X2(3+8)*2/((S2-S1)^2) + X2(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X2(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X2(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X2(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X2(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);
        desired_state.acc(3,1) = X3(3+8)*2/((S2-S1)^2) + X3(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X3(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X3(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X3(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X3(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);

<span class="comment">%         desired_state.pos(1,1) = subs(p2x, t, t_real);</span>
<span class="comment">%         desired_state.pos(2,1) = subs(p2y, t, t_real);</span>
<span class="comment">%         desired_state.pos(3,1) = subs(p2z, t, t_real);</span>
<span class="comment">%         desired_state.vel(1,1) = subs(diff(p2x,t), t, t_real);</span>
<span class="comment">%         desired_state.vel(2,1) = subs(diff(p2y,t), t, t_real);</span>
<span class="comment">%         desired_state.vel(3,1) = subs(diff(p2z,t), t, t_real);</span>
<span class="comment">%         desired_state.acc(1,1) = subs(diff(p2x,t,2), t, t_real);</span>
<span class="comment">%         desired_state.acc(2,1) = subs(diff(p2y,t,2), t, t_real);</span>
<span class="comment">%         desired_state.acc(3,1) = subs(diff(p2z,t,2), t, t_real);</span>
    <span class="keyword">elseif</span>(t_real&gt;=traj_time(3) &amp;&amp; t_real&lt;traj_time(4))
        desired_state.pos(1,1) = X1(1+16) + X1(2+16)*(t_real-S2)/(S3-S2) + X1(3+16)*((t_real-S2)/(S3-S2))^2 + X1(4+16)*((t_real-S2)/(S3-S2))^3 + X1(5+16)*((t_real-S2)/(S3-S2))^4 + X1(6+16)*((t_real-S2)/(S3-S2))^5 + X1(7+16)*((t_real-S2)/(S3-S2))^6 + X1(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.pos(2,1) = X2(1+16) + X2(2+16)*(t_real-S2)/(S3-S2) + X2(3+16)*((t_real-S2)/(S3-S2))^2 + X2(4+16)*((t_real-S2)/(S3-S2))^3 + X2(5+16)*((t_real-S2)/(S3-S2))^4 + X2(6+16)*((t_real-S2)/(S3-S2))^5 + X2(7+16)*((t_real-S2)/(S3-S2))^6 + X2(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.pos(3,1) = X3(1+16) + X3(2+16)*(t_real-S2)/(S3-S2) + X3(3+16)*((t_real-S2)/(S3-S2))^2 + X3(4+16)*((t_real-S2)/(S3-S2))^3 + X3(5+16)*((t_real-S2)/(S3-S2))^4 + X3(6+16)*((t_real-S2)/(S3-S2))^5 + X3(7+16)*((t_real-S2)/(S3-S2))^6 + X3(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.vel(1,1) = X1(2+16)/(S3-S2) + X1(3+16)*2*(t_real-S2)/((S3-S2)^2) + X1(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X1(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X1(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X1(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X1(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.vel(2,1) = X2(2+16)/(S3-S2) + X2(3+16)*2*(t_real-S2)/((S3-S2)^2) + X2(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X2(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X2(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X2(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X2(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.vel(3,1) = X3(2+16)/(S3-S2) + X3(3+16)*2*(t_real-S2)/((S3-S2)^2) + X3(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X3(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X3(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X3(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X3(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.acc(1,1) = X1(3+16)*2/((S3-S2)^2) + X1(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X1(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X1(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X1(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X1(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
        desired_state.acc(2,1) = X2(3+16)*2/((S3-S2)^2) + X2(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X2(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X2(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X2(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X2(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
        desired_state.acc(3,1) = X3(3+16)*2/((S3-S2)^2) + X3(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X3(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X3(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X3(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X3(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
    <span class="keyword">elseif</span>(t_real&gt;=traj_time(4) &amp;&amp; t_real&lt;=traj_time(5))
        desired_state.pos(1,1) = X1(1+24) + X1(2+24)*(t_real-S3)/(S4-S3) + X1(3+24)*((t_real-S3)/(S4-S3))^2 + X1(4+24)*((t_real-S3)/(S4-S3))^3 + X1(5+24)*((t_real-S3)/(S4-S3))^4 + X1(6+24)*((t_real-S3)/(S4-S3))^5 + X1(7+24)*((t_real-S3)/(S4-S3))^6 + X1(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.pos(2,1) = X2(1+24) + X2(2+24)*(t_real-S3)/(S4-S3) + X2(3+24)*((t_real-S3)/(S4-S3))^2 + X2(4+24)*((t_real-S3)/(S4-S3))^3 + X2(5+24)*((t_real-S3)/(S4-S3))^4 + X2(6+24)*((t_real-S3)/(S4-S3))^5 + X2(7+24)*((t_real-S3)/(S4-S3))^6 + X2(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.pos(3,1) = X3(1+24) + X3(2+24)*(t_real-S3)/(S4-S3) + X3(3+24)*((t_real-S3)/(S4-S3))^2 + X3(4+24)*((t_real-S3)/(S4-S3))^3 + X3(5+24)*((t_real-S3)/(S4-S3))^4 + X3(6+24)*((t_real-S3)/(S4-S3))^5 + X3(7+24)*((t_real-S3)/(S4-S3))^6 + X3(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.vel(1,1) = X1(2+24)/(S4-S3) + X1(3+24)*2*(t_real-S3)/((S4-S3)^2) + X1(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X1(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X1(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X1(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X1(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.vel(2,1) = X2(2+24)/(S4-S3) + X2(3+24)*2*(t_real-S3)/((S4-S3)^2) + X2(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X2(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X2(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X2(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X2(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.vel(3,1) = X3(2+24)/(S4-S3) + X3(3+24)*2*(t_real-S3)/((S4-S3)^2) + X3(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X3(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X3(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X3(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X3(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.acc(1,1) = X1(3+24)*2/((S4-S3)^2) + X1(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X1(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X1(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X1(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X1(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
        desired_state.acc(2,1) = X2(3+24)*2/((S4-S3)^2) + X2(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X2(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X2(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X2(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X2(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
        desired_state.acc(3,1) = X3(3+24)*2/((S4-S3)^2) + X3(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X3(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X3(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X3(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X3(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
    <span class="keyword">end</span>
    <span class="comment">%     t_index = find(traj_time &gt;= t,1);</span>
    <span class="comment">%</span>
    <span class="comment">%     if(t_index &gt; 1)</span>
    <span class="comment">%         t = t - traj_time(t_index-1);</span>
    <span class="comment">%     end</span>
    <span class="comment">%     if(t == 0)</span>
    <span class="comment">%         desired_state.pos = waypoints0(:,1);</span>
    <span class="comment">%     else</span>
    <span class="comment">%         scale = t/d0(t_index-1);</span>
    <span class="comment">%         desired_state.pos = (1 - scale) * waypoints0(:,t_index-1) + scale * waypoints0(:,t_index);</span>
    <span class="comment">%     end</span>
<span class="comment">%     desired_state.pos = (desired_state.pos)';</span>
<span class="comment">%     desired_state.vel = zeros(3,1);</span>
<span class="comment">%     desired_state.acc = zeros(3,1);</span>
    desired_state.yaw = 0;
    desired_state.yawdot = 0;
<span class="keyword">end</span>
<span class="comment">% desired_state.pos = zeros(3,1);</span>
<span class="comment">% desired_state.vel = zeros(3,1);</span>
<span class="comment">% desired_state.acc = zeros(3,1);</span>
<span class="comment">% desired_state.yaw = 0;</span>
</pre><pre class="codeoutput">Index exceeds matrix dimensions.

Error in traj_generator (line 187)
    S0 = traj_time(1);
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2012b</a><br></p></div><!--
##### SOURCE BEGIN #####
function [ desired_state ] = traj_generator(t_real, state, waypoints)
% TRAJ_GENERATOR: Generate the trajectory passing through all
% positions listed in the waypoints list
%
% NOTE: This function would be called with variable number of input arguments.
% During initialization, it will be called with arguments
% trajectory_generator([], [], waypoints) and later, while testing, it will be
% called with only t and state as arguments, so your code should be able to
% handle that. This can be done by checking the number of arguments to the
% function using the "nargin" variable, check the MATLAB documentation for more
% information.
%
% t,state: time and current state (same variable as "state" in controller)
% that you may use for computing desired_state
%
% waypoints: The 3xP matrix listing all the points you much visited in order
% along the generated trajectory
%
% desired_state: Contains all the information that is passed to the
% controller for generating inputs for the quadrotor
%
% It is suggested to use "persistent" variables to store the waypoints during
% the initialization call of trajectory_generator.


%% Example code:
% Note that this is an example of naive trajectory generator that simply moves
% the quadrotor along a stright line between each pair of consecutive waypoints
% using a constant velocity of 0.5 m/s. Note that this is only a sample, and you
% should write your own trajectory generator for the submission.

% persistent waypoints0 traj_time d0
% if nargin > 2
%     d = waypoints(:,2:end) - waypoints(:,1:end-1);
%     d0 = 2 * sqrt(d(1,:).^2 + d(2,:).^2 + d(3,:).^2);
%     traj_time = [0, cumsum(d0)];
%     waypoints0 = waypoints;
% else
%     if(t > traj_time(end))
%         t = traj_time(end);
%     end
%     t_index = find(traj_time >= t,1);
%
%     if(t_index > 1)
%         t = t - traj_time(t_index-1);
%     end
%     if(t == 0)
%         desired_state.pos = waypoints0(:,1);
%     else
%         scale = t/d0(t_index-1);
%         desired_state.pos = (1 - scale) * waypoints0(:,t_index-1) + scale * waypoints0(:,t_index);
%     end
%     desired_state.vel = zeros(3,1);
%     desired_state.acc = zeros(3,1);
%     desired_state.yaw = 0;
%     desired_state.yawdot = 0;
% end
%


%% Fill in your code here

persistent X1 X2 X3
persistent waypoints0 traj_time d0
if nargin > 2
    d = waypoints(:,2:end) - waypoints(:,1:end-1);
    d0 = 2 * sqrt(d(1,:).^2 + d(2,:).^2 + d(3,:).^2);
    traj_time = [0, cumsum(d0)];
    waypoints0 = waypoints;
    %    we should solve for x, y, z independently, we really need coefficients alpha_ij^x, alpha_ij^y, alpha_ij^z and they will be different.
    %    https://www.coursera.org/learn/robotics-flight/discussions/weeks/4/threads/7Ug8_GpJEeasOQpiYXGJHw
    
    syms t positive
    syms c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7 real
    syms c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7 real
    syms c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7 real
    syms c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7 real
    syms p1 p2 p3 p4
    S0 = traj_time(1);
    S1 = traj_time(2);
    S2 = traj_time(3);
    S3 = traj_time(4);
    S4 = traj_time(5);
    p1 = c_1_0 + c_1_1*(t-S0)/(S1-S0) + c_1_2*((t-S0)/(S1-S0))^2 + c_1_3*((t-S0)/(S1-S0))^3 + c_1_4*((t-S0)/(S1-S0))^4 + c_1_5*((t-S0)/(S1-S0))^5 + c_1_6*((t-S0)/(S1-S0))^6 + c_1_7*((t-S0)/(S1-S0))^7;
    p2 = c_2_0 + c_2_1*(t-S1)/(S2-S1) + c_2_2*((t-S1)/(S2-S1))^2 + c_2_3*((t-S1)/(S2-S1))^3 + c_2_4*((t-S1)/(S2-S1))^4 + c_2_5*((t-S1)/(S2-S1))^5 + c_2_6*((t-S1)/(S2-S1))^6 + c_2_7*((t-S1)/(S2-S1))^7;
    p3 = c_3_0 + c_3_1*(t-S2)/(S3-S2) + c_3_2*((t-S2)/(S3-S2))^2 + c_3_3*((t-S2)/(S3-S2))^3 + c_3_4*((t-S2)/(S3-S2))^4 + c_3_5*((t-S2)/(S3-S2))^5 + c_3_6*((t-S2)/(S3-S2))^6 + c_3_7*((t-S2)/(S3-S2))^7;
    p4 = c_4_0 + c_4_1*(t-S3)/(S4-S3) + c_4_2*((t-S3)/(S4-S3))^2 + c_4_3*((t-S3)/(S4-S3))^3 + c_4_4*((t-S3)/(S4-S3))^4 + c_4_5*((t-S3)/(S4-S3))^5 + c_4_6*((t-S3)/(S4-S3))^6 + c_4_7*((t-S3)/(S4-S3))^7;
    
    p1dot = diff(p1,t);
    p2dot = diff(p2,t);
    p3dot = diff(p3,t);
    p4dot = diff(p4,t);
    p1dot2 = diff(p1dot, t);
    p2dot2 = diff(p2dot, t);
    p3dot2 = diff(p3dot, t);
    p4dot2 = diff(p4dot, t);
    p1dot3 = diff(p1dot2, t);
    p2dot3 = diff(p2dot2, t);
    p3dot3 = diff(p3dot2, t);
    p4dot3 = diff(p4dot2, t);
    p1dot4 = diff(p1dot3, t);
    p2dot4 = diff(p2dot3, t);
    p3dot4 = diff(p3dot3, t);
    p4dot4 = diff(p4dot3, t);
    p1dot5 = diff(p1dot4, t);
    p2dot5 = diff(p2dot4, t);
    p3dot5 = diff(p3dot4, t);
    p4dot5 = diff(p4dot4, t);
    p1dot6 = diff(p1dot5, t);
    p2dot6 = diff(p2dot5, t);
    p3dot6 = diff(p3dot5, t);
    p4dot6 = diff(p4dot5, t);
    
    A = zeros(32, 32);
    b = zeros(32, 1);
    
    
    A(1, 1:8) = subs(jacobian(p1, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(2, 1:8) = subs(jacobian(p1, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(3, 9:16) = subs(jacobian(p2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(4, 9:16) = subs(jacobian(p2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(5, 17:24) = subs(jacobian(p3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(6, 17:24) = subs(jacobian(p3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(7, 25:32) = subs(jacobian(p4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(8, 25:32) = subs(jacobian(p4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(9, 1:8) = subs(jacobian(p1dot, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(10, 25:32) = subs(jacobian(p4dot, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(11, 1:8) = subs(jacobian(p1dot2, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(12, 25:32) = subs(jacobian(p4dot2, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    A(13, 1:8) = subs(jacobian(p1dot3, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S0);
    A(14, 25:32) = subs(jacobian(p4dot3, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S4);
    
    A(15, 1:8) = subs(jacobian(p1dot, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(15, 9:16) = -subs(jacobian(p2dot, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(16, 1:8) = subs(jacobian(p1dot2, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(16, 9:16) = -subs(jacobian(p2dot2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(17, 1:8) = subs(jacobian(p1dot3, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(17, 9:16) = -subs(jacobian(p2dot3, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(18, 1:8) = subs(jacobian(p1dot4, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(18, 9:16) = -subs(jacobian(p2dot4, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(19, 1:8) = subs(jacobian(p1dot5, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(19, 9:16) = -subs(jacobian(p2dot5, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    A(20, 1:8) = subs(jacobian(p1dot6, [c_1_0 c_1_1 c_1_2 c_1_3 c_1_4 c_1_5 c_1_6 c_1_7]), t, S1);
    A(20, 9:16) = -subs(jacobian(p2dot6, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S1);
    
    A(21, 9:16) = subs(jacobian(p2dot, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(21, 17:24) = -subs(jacobian(p3dot, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(22, 9:16) = subs(jacobian(p2dot2, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(22, 17:24) = -subs(jacobian(p3dot2, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(23, 9:16) = subs(jacobian(p2dot3, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(23, 17:24) = -subs(jacobian(p3dot3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(24, 9:16) = subs(jacobian(p2dot4, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(24, 17:24) = -subs(jacobian(p3dot4, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(25, 9:16) = subs(jacobian(p2dot5, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(25, 17:24) = -subs(jacobian(p3dot5, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    A(26, 9:16) = subs(jacobian(p2dot6, [c_2_0 c_2_1 c_2_2 c_2_3 c_2_4 c_2_5 c_2_6 c_2_7]), t, S2);
    A(26, 17:24) = -subs(jacobian(p3dot6, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S2);
    
    A(27, 17:24) = subs(jacobian(p3dot, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(27, 25:32) = -subs(jacobian(p4dot, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(28, 17:24) = subs(jacobian(p3dot2, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(28, 25:32) = -subs(jacobian(p4dot2, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(29, 17:24) = subs(jacobian(p3dot3, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(29, 25:32) = -subs(jacobian(p4dot3, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(30, 17:24) = subs(jacobian(p3dot4, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(30, 25:32) = -subs(jacobian(p4dot4, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(31, 17:24) = subs(jacobian(p3dot5, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(31, 25:32) = -subs(jacobian(p4dot5, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    A(32, 17:24) = subs(jacobian(p3dot6, [c_3_0 c_3_1 c_3_2 c_3_3 c_3_4 c_3_5 c_3_6 c_3_7]), t, S3);
    A(32, 25:32) = -subs(jacobian(p4dot6, [c_4_0 c_4_1 c_4_2 c_4_3 c_4_4 c_4_5 c_4_6 c_4_7]), t, S3);
    for k = 1:3
        for i = 1:(size(waypoints, 2)-1)
            b(2*i-1) = waypoints(k, i);
            b(2*i) = waypoints(k, i+1);
        end
        if(k == 1)
            X1 = A \ b;
        elseif(k==2)
            X2 = A \ b;
        elseif(k==3)
            X3 = A \ b;
        end
    end
else
%     the next line, syms function, really takes a very long time, so DO NOT USE IT DURING LOOP!
%     syms t 
    S0 = traj_time(1);
    S1 = traj_time(2);
    S2 = traj_time(3);
    S3 = traj_time(4);
    S4 = traj_time(5);
%     
%     p1x = X1(1) + X1(2)*(t-S0)/(S1-S0) + X1(3)*((t-S0)/(S1-S0))^2 + X1(4)*((t-S0)/(S1-S0))^3 + X1(5)*((t-S0)/(S1-S0))^4 + X1(6)*((t-S0)/(S1-S0))^5 + X1(7)*((t-S0)/(S1-S0))^6 + X1(8)*((t-S0)/(S1-S0))^7;
%     p2x = X1(9) + X1(10)*(t-S1)/(S2-S1) + X1(11)*((t-S1)/(S2-S1))^2 + X1(12)*((t-S1)/(S2-S1))^3 + X1(13)*((t-S1)/(S2-S1))^4 + X1(14)*((t-S1)/(S2-S1))^5 + X1(15)*((t-S1)/(S2-S1))^6 + X1(16)*((t-S1)/(S2-S1))^7;
%     p3x = X1(17) + X1(18)*(t-S2)/(S3-S2) + X1(19)*((t-S2)/(S3-S2))^2 + X1(20)*((t-S2)/(S3-S2))^3 + X1(21)*((t-S2)/(S3-S2))^4 + X1(22)*((t-S2)/(S3-S2))^5 + X1(23)*((t-S2)/(S3-S2))^6 + X1(24)*((t-S2)/(S3-S2))^7;
%     p4x = X1(25) + X1(26)*(t-S3)/(S4-S3) + X1(27)*((t-S3)/(S4-S3))^2 + X1(28)*((t-S3)/(S4-S3))^3 + X1(29)*((t-S3)/(S4-S3))^4 + X1(30)*((t-S3)/(S4-S3))^5 + X1(31)*((t-S3)/(S4-S3))^6 + X1(32)*((t-S3)/(S4-S3))^7;
%     
%     p1y = X2(1) + X2(2)*(t-S0)/(S1-S0) + X2(3)*((t-S0)/(S1-S0))^2 + X2(4)*((t-S0)/(S1-S0))^3 + X2(5)*((t-S0)/(S1-S0))^4 + X2(6)*((t-S0)/(S1-S0))^5 + X2(7)*((t-S0)/(S1-S0))^6 + X2(8)*((t-S0)/(S1-S0))^7;
%     p2y = X2(9) + X2(10)*(t-S1)/(S2-S1) + X2(11)*((t-S1)/(S2-S1))^2 + X2(12)*((t-S1)/(S2-S1))^3 + X2(13)*((t-S1)/(S2-S1))^4 + X2(14)*((t-S1)/(S2-S1))^5 + X2(15)*((t-S1)/(S2-S1))^6 + X2(16)*((t-S1)/(S2-S1))^7;
%     p3y = X2(17) + X2(18)*(t-S2)/(S3-S2) + X2(19)*((t-S2)/(S3-S2))^2 + X2(20)*((t-S2)/(S3-S2))^3 + X2(21)*((t-S2)/(S3-S2))^4 + X2(22)*((t-S2)/(S3-S2))^5 + X2(23)*((t-S2)/(S3-S2))^6 + X2(24)*((t-S2)/(S3-S2))^7;
%     p4y = X2(25) + X2(26)*(t-S3)/(S4-S3) + X2(27)*((t-S3)/(S4-S3))^2 + X2(28)*((t-S3)/(S4-S3))^3 + X2(29)*((t-S3)/(S4-S3))^4 + X2(30)*((t-S3)/(S4-S3))^5 + X2(31)*((t-S3)/(S4-S3))^6 + X2(32)*((t-S3)/(S4-S3))^7;
%     
%     p1z = X3(1) + X3(2)*(t-S0)/(S1-S0) + X3(3)*((t-S0)/(S1-S0))^2 + X3(4)*((t-S0)/(S1-S0))^3 + X3(5)*((t-S0)/(S1-S0))^4 + X3(6)*((t-S0)/(S1-S0))^5 + X3(7)*((t-S0)/(S1-S0))^6 + X3(8)*((t-S0)/(S1-S0))^7;
%     p2z = X3(9) + X3(10)*(t-S1)/(S2-S1) + X3(11)*((t-S1)/(S2-S1))^2 + X3(12)*((t-S1)/(S2-S1))^3 + X3(13)*((t-S1)/(S2-S1))^4 + X3(14)*((t-S1)/(S2-S1))^5 + X3(15)*((t-S1)/(S2-S1))^6 + X3(16)*((t-S1)/(S2-S1))^7;
%     p3z = X3(17) + X3(18)*(t-S2)/(S3-S2) + X3(19)*((t-S2)/(S3-S2))^2 + X3(20)*((t-S2)/(S3-S2))^3 + X3(21)*((t-S2)/(S3-S2))^4 + X3(22)*((t-S2)/(S3-S2))^5 + X3(23)*((t-S2)/(S3-S2))^6 + X3(24)*((t-S2)/(S3-S2))^7;
%     p4z = X3(25) + X3(26)*(t-S3)/(S4-S3) + X3(27)*((t-S3)/(S4-S3))^2 + X3(28)*((t-S3)/(S4-S3))^3 + X3(29)*((t-S3)/(S4-S3))^4 + X3(30)*((t-S3)/(S4-S3))^5 + X3(31)*((t-S3)/(S4-S3))^6 + X3(32)*((t-S3)/(S4-S3))^7;
    
    if(t_real >= traj_time(end))
        t_real = traj_time(end);
    end
    
    if(t_real>=traj_time(1) && t_real<traj_time(2))
        desired_state.pos(1,1) = X1(1) + X1(2)*(t_real-S0)/(S1-S0) + X1(3)*((t_real-S0)/(S1-S0))^2 + X1(4)*((t_real-S0)/(S1-S0))^3 + X1(5)*((t_real-S0)/(S1-S0))^4 + X1(6)*((t_real-S0)/(S1-S0))^5 + X1(7)*((t_real-S0)/(S1-S0))^6 + X1(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.pos(2,1) = X2(1) + X2(2)*(t_real-S0)/(S1-S0) + X2(3)*((t_real-S0)/(S1-S0))^2 + X2(4)*((t_real-S0)/(S1-S0))^3 + X2(5)*((t_real-S0)/(S1-S0))^4 + X2(6)*((t_real-S0)/(S1-S0))^5 + X2(7)*((t_real-S0)/(S1-S0))^6 + X2(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.pos(3,1) = X3(1) + X3(2)*(t_real-S0)/(S1-S0) + X3(3)*((t_real-S0)/(S1-S0))^2 + X3(4)*((t_real-S0)/(S1-S0))^3 + X3(5)*((t_real-S0)/(S1-S0))^4 + X3(6)*((t_real-S0)/(S1-S0))^5 + X3(7)*((t_real-S0)/(S1-S0))^6 + X3(8)*((t_real-S0)/(S1-S0))^7;
        desired_state.vel(1,1) = X1(2)/(S1-S0) + X1(3)*2*(t_real-S0)/((S1-S0)^2) + X1(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X1(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X1(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X1(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X1(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.vel(2,1) = X2(2)/(S1-S0) + X2(3)*2*(t_real-S0)/((S1-S0)^2) + X2(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X2(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X2(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X2(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X2(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.vel(3,1) = X3(2)/(S1-S0) + X3(3)*2*(t_real-S0)/((S1-S0)^2) + X3(4)*3*((t_real-S0)^2)/((S1-S0)^3) + X3(5)*4*((t_real-S0)^3)/((S1-S0)^4) + X3(6)*5*((t_real-S0)^4)/((S1-S0)^5) + X3(7)*6*((t_real-S0)^5)/((S1-S0)^6) + X3(8)*7*((t_real-S0)^6)/((S1-S0)^7);
        desired_state.acc(1,1) = X1(3)*2/((S1-S0)^2) + X1(4)*3*2*(t_real-S0)/((S1-S0)^3) + X1(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X1(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X1(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X1(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
        desired_state.acc(2,1) = X2(3)*2/((S1-S0)^2) + X2(4)*3*2*(t_real-S0)/((S1-S0)^3) + X2(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X2(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X2(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X2(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
        desired_state.acc(3,1) = X3(3)*2/((S1-S0)^2) + X3(4)*3*2*(t_real-S0)/((S1-S0)^3) + X3(5)*4*3*((t_real-S0)^2)/((S1-S0)^4) + X3(6)*5*4*((t_real-S0)^3)/((S1-S0)^5) + X3(7)*6*5*((t_real-S0)^4)/((S1-S0)^6) + X3(8)*7*6*((t_real-S0)^5)/((S1-S0)^7);
    elseif(t_real>=traj_time(2) && t_real<traj_time(3))
		desired_state.pos(1,1) = X1(1+8) + X1(2+8)*(t_real-S1)/(S2-S1) + X1(3+8)*((t_real-S1)/(S2-S1))^2 + X1(4+8)*((t_real-S1)/(S2-S1))^3 + X1(5+8)*((t_real-S1)/(S2-S1))^4 + X1(6+8)*((t_real-S1)/(S2-S1))^5 + X1(7+8)*((t_real-S1)/(S2-S1))^6 + X1(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.pos(2,1) = X2(1+8) + X2(2+8)*(t_real-S1)/(S2-S1) + X2(3+8)*((t_real-S1)/(S2-S1))^2 + X2(4+8)*((t_real-S1)/(S2-S1))^3 + X2(5+8)*((t_real-S1)/(S2-S1))^4 + X2(6+8)*((t_real-S1)/(S2-S1))^5 + X2(7+8)*((t_real-S1)/(S2-S1))^6 + X2(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.pos(3,1) = X3(1+8) + X3(2+8)*(t_real-S1)/(S2-S1) + X3(3+8)*((t_real-S1)/(S2-S1))^2 + X3(4+8)*((t_real-S1)/(S2-S1))^3 + X3(5+8)*((t_real-S1)/(S2-S1))^4 + X3(6+8)*((t_real-S1)/(S2-S1))^5 + X3(7+8)*((t_real-S1)/(S2-S1))^6 + X3(8+8)*((t_real-S1)/(S2-S1))^7;
        desired_state.vel(1,1) = X1(2+8)/(S2-S1) + X1(3+8)*2*(t_real-S1)/((S2-S1)^2) + X1(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X1(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X1(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X1(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X1(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.vel(2,1) = X2(2+8)/(S2-S1) + X2(3+8)*2*(t_real-S1)/((S2-S1)^2) + X2(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X2(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X2(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X2(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X2(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.vel(3,1) = X3(2+8)/(S2-S1) + X3(3+8)*2*(t_real-S1)/((S2-S1)^2) + X3(4+8)*3*((t_real-S1)^2)/((S2-S1)^3) + X3(5+8)*4*((t_real-S1)^3)/((S2-S1)^4) + X3(6+8)*5*((t_real-S1)^4)/((S2-S1)^5) + X3(7+8)*6*((t_real-S1)^5)/((S2-S1)^6) + X3(8+8)*7*((t_real-S1)^6)/((S2-S1)^7);
        desired_state.acc(1,1) = X1(3+8)*2/((S2-S1)^2) + X1(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X1(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X1(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X1(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X1(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);
        desired_state.acc(2,1) = X2(3+8)*2/((S2-S1)^2) + X2(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X2(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X2(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X2(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X2(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);
        desired_state.acc(3,1) = X3(3+8)*2/((S2-S1)^2) + X3(4+8)*3*2*(t_real-S1)/((S2-S1)^3) + X3(5+8)*4*3*((t_real-S1)^2)/((S2-S1)^4) + X3(6+8)*5*4*((t_real-S1)^3)/((S2-S1)^5) + X3(7+8)*6*5*((t_real-S1)^4)/((S2-S1)^6) + X3(8+8)*7*6*((t_real-S1)^5)/((S2-S1)^7);

%         desired_state.pos(1,1) = subs(p2x, t, t_real);
%         desired_state.pos(2,1) = subs(p2y, t, t_real);
%         desired_state.pos(3,1) = subs(p2z, t, t_real);
%         desired_state.vel(1,1) = subs(diff(p2x,t), t, t_real);
%         desired_state.vel(2,1) = subs(diff(p2y,t), t, t_real);
%         desired_state.vel(3,1) = subs(diff(p2z,t), t, t_real);
%         desired_state.acc(1,1) = subs(diff(p2x,t,2), t, t_real);
%         desired_state.acc(2,1) = subs(diff(p2y,t,2), t, t_real);
%         desired_state.acc(3,1) = subs(diff(p2z,t,2), t, t_real);
    elseif(t_real>=traj_time(3) && t_real<traj_time(4))
        desired_state.pos(1,1) = X1(1+16) + X1(2+16)*(t_real-S2)/(S3-S2) + X1(3+16)*((t_real-S2)/(S3-S2))^2 + X1(4+16)*((t_real-S2)/(S3-S2))^3 + X1(5+16)*((t_real-S2)/(S3-S2))^4 + X1(6+16)*((t_real-S2)/(S3-S2))^5 + X1(7+16)*((t_real-S2)/(S3-S2))^6 + X1(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.pos(2,1) = X2(1+16) + X2(2+16)*(t_real-S2)/(S3-S2) + X2(3+16)*((t_real-S2)/(S3-S2))^2 + X2(4+16)*((t_real-S2)/(S3-S2))^3 + X2(5+16)*((t_real-S2)/(S3-S2))^4 + X2(6+16)*((t_real-S2)/(S3-S2))^5 + X2(7+16)*((t_real-S2)/(S3-S2))^6 + X2(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.pos(3,1) = X3(1+16) + X3(2+16)*(t_real-S2)/(S3-S2) + X3(3+16)*((t_real-S2)/(S3-S2))^2 + X3(4+16)*((t_real-S2)/(S3-S2))^3 + X3(5+16)*((t_real-S2)/(S3-S2))^4 + X3(6+16)*((t_real-S2)/(S3-S2))^5 + X3(7+16)*((t_real-S2)/(S3-S2))^6 + X3(8+16)*((t_real-S2)/(S3-S2))^7;
        desired_state.vel(1,1) = X1(2+16)/(S3-S2) + X1(3+16)*2*(t_real-S2)/((S3-S2)^2) + X1(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X1(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X1(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X1(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X1(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.vel(2,1) = X2(2+16)/(S3-S2) + X2(3+16)*2*(t_real-S2)/((S3-S2)^2) + X2(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X2(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X2(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X2(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X2(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.vel(3,1) = X3(2+16)/(S3-S2) + X3(3+16)*2*(t_real-S2)/((S3-S2)^2) + X3(4+16)*3*((t_real-S2)^2)/((S3-S2)^3) + X3(5+16)*4*((t_real-S2)^3)/((S3-S2)^4) + X3(6+16)*5*((t_real-S2)^4)/((S3-S2)^5) + X3(7+16)*6*((t_real-S2)^5)/((S3-S2)^6) + X3(8+16)*7*((t_real-S2)^6)/((S3-S2)^7);
        desired_state.acc(1,1) = X1(3+16)*2/((S3-S2)^2) + X1(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X1(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X1(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X1(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X1(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
        desired_state.acc(2,1) = X2(3+16)*2/((S3-S2)^2) + X2(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X2(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X2(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X2(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X2(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
        desired_state.acc(3,1) = X3(3+16)*2/((S3-S2)^2) + X3(4+16)*3*2*(t_real-S2)/((S3-S2)^3) + X3(5+16)*4*3*((t_real-S2)^2)/((S3-S2)^4) + X3(6+16)*5*4*((t_real-S2)^3)/((S3-S2)^5) + X3(7+16)*6*5*((t_real-S2)^4)/((S3-S2)^6) + X3(8+16)*7*6*((t_real-S2)^5)/((S3-S2)^7);
    elseif(t_real>=traj_time(4) && t_real<=traj_time(5))
        desired_state.pos(1,1) = X1(1+24) + X1(2+24)*(t_real-S3)/(S4-S3) + X1(3+24)*((t_real-S3)/(S4-S3))^2 + X1(4+24)*((t_real-S3)/(S4-S3))^3 + X1(5+24)*((t_real-S3)/(S4-S3))^4 + X1(6+24)*((t_real-S3)/(S4-S3))^5 + X1(7+24)*((t_real-S3)/(S4-S3))^6 + X1(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.pos(2,1) = X2(1+24) + X2(2+24)*(t_real-S3)/(S4-S3) + X2(3+24)*((t_real-S3)/(S4-S3))^2 + X2(4+24)*((t_real-S3)/(S4-S3))^3 + X2(5+24)*((t_real-S3)/(S4-S3))^4 + X2(6+24)*((t_real-S3)/(S4-S3))^5 + X2(7+24)*((t_real-S3)/(S4-S3))^6 + X2(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.pos(3,1) = X3(1+24) + X3(2+24)*(t_real-S3)/(S4-S3) + X3(3+24)*((t_real-S3)/(S4-S3))^2 + X3(4+24)*((t_real-S3)/(S4-S3))^3 + X3(5+24)*((t_real-S3)/(S4-S3))^4 + X3(6+24)*((t_real-S3)/(S4-S3))^5 + X3(7+24)*((t_real-S3)/(S4-S3))^6 + X3(8+24)*((t_real-S3)/(S4-S3))^7;
        desired_state.vel(1,1) = X1(2+24)/(S4-S3) + X1(3+24)*2*(t_real-S3)/((S4-S3)^2) + X1(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X1(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X1(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X1(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X1(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.vel(2,1) = X2(2+24)/(S4-S3) + X2(3+24)*2*(t_real-S3)/((S4-S3)^2) + X2(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X2(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X2(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X2(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X2(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.vel(3,1) = X3(2+24)/(S4-S3) + X3(3+24)*2*(t_real-S3)/((S4-S3)^2) + X3(4+24)*3*((t_real-S3)^2)/((S4-S3)^3) + X3(5+24)*4*((t_real-S3)^3)/((S4-S3)^4) + X3(6+24)*5*((t_real-S3)^4)/((S4-S3)^5) + X3(7+24)*6*((t_real-S3)^5)/((S4-S3)^6) + X3(8+24)*7*((t_real-S3)^6)/((S4-S3)^7);
        desired_state.acc(1,1) = X1(3+24)*2/((S4-S3)^2) + X1(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X1(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X1(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X1(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X1(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
        desired_state.acc(2,1) = X2(3+24)*2/((S4-S3)^2) + X2(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X2(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X2(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X2(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X2(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
        desired_state.acc(3,1) = X3(3+24)*2/((S4-S3)^2) + X3(4+24)*3*2*(t_real-S3)/((S4-S3)^3) + X3(5+24)*4*3*((t_real-S3)^2)/((S4-S3)^4) + X3(6+24)*5*4*((t_real-S3)^3)/((S4-S3)^5) + X3(7+24)*6*5*((t_real-S3)^4)/((S4-S3)^6) + X3(8+24)*7*6*((t_real-S3)^5)/((S4-S3)^7);
    end
    %     t_index = find(traj_time >= t,1);
    %
    %     if(t_index > 1)
    %         t = t - traj_time(t_index-1);
    %     end
    %     if(t == 0)
    %         desired_state.pos = waypoints0(:,1);
    %     else
    %         scale = t/d0(t_index-1);
    %         desired_state.pos = (1 - scale) * waypoints0(:,t_index-1) + scale * waypoints0(:,t_index);
    %     end
%     desired_state.pos = (desired_state.pos)';
%     desired_state.vel = zeros(3,1);
%     desired_state.acc = zeros(3,1);
    desired_state.yaw = 0;
    desired_state.yawdot = 0;
end
% desired_state.pos = zeros(3,1);
% desired_state.vel = zeros(3,1);
% desired_state.acc = zeros(3,1);
% desired_state.yaw = 0;
end


##### SOURCE END #####
--></body></html>